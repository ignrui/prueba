name: CI/CD Pipeline con Self-Hosted Runner

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: Code Quality - Lint
    runs-on: self-hosted
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      # âŒ ELIMINAR ESTO:
      # - name: Set up Python
      #   uses: actions/setup-python@v4
      #   with:
      #     python-version: ${{ env.PYTHON_VERSION }}
      
      # âœ… USAR DIRECTAMENTE:
      - name: Install linting dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install flake8 black pylint
      
      - name: Run flake8
        run: python3 -m flake8 app.py tests/ --max-line-length=120 --exclude=__pycache__
      
      - name: Run black (check only)
        run: python3 -m black --check app.py tests/
      
      - name: Run pylint
        run: python3 -m pylint app.py --disable=C0111,R0903
        continue-on-error: true

  unit-tests:
    name: Unit Tests
    runs-on: self-hosted
    needs: lint
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      # âŒ NO usar setup-python
      
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m pip install -r requirements-dev.txt
      
      - name: Run unit tests
        run: |
          python3 -m pytest tests/test_unit.py -v \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=html
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30

  build:
    name: Build Docker Image
    runs-on: self-hosted
    needs: unit-tests
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Build Docker images
        run: |
          docker build -t flask-task-api:${{ github.sha }} .
          
          if [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            docker tag flask-task-api:${{ github.sha }} flask-task-api:staging
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            docker tag flask-task-api:${{ github.sha }} flask-task-api:production
          fi
      
      - name: Verificar imÃ¡genes creadas
        run: docker images | grep flask-task-api

  integration-tests:
    name: Integration Tests
    runs-on: self-hosted
    needs: build
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Start test database
        run: |
          docker run -d \
            --name test-postgres \
            -e POSTGRES_USER=devops \
            -e POSTGRES_PASSWORD=devops123 \
            -e POSTGRES_DB=tasksdb \
            -p 5435:5432 \
            postgres:15-alpine
          
          echo "â³ Esperando PostgreSQL..."
          sleep 10
      
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m pip install -r requirements-dev.txt
      
      - name: Start Flask app for testing
        run: |
          export DATABASE_URL=postgresql://devops:devops123@localhost:5435/tasksdb
          python3 app.py &
          APP_PID=$!
          echo $APP_PID > app.pid
          sleep 5
      
      - name: Initialize database
        run: |
          export DATABASE_URL=postgresql://devops:devops123@localhost:5435/tasksdb
          python3 -c "from app import create_app, db; app = create_app(); app.app_context().push(); db.create_all()"
            
      - name: Run integration tests
        run: |
          export API_BASE_URL=http://localhost:5000
          python3 -m pytest tests/test_integration.py -v
      
      - name: Cleanup
        if: always()
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) || true
            rm app.pid
          fi
          docker stop test-postgres || true
          docker rm test-postgres || true

  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: self-hosted
    needs: integration-tests
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: http://localhost:5001
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Stop previous staging containers
        run: |
          docker-compose -f docker-compose.staging.yml down || true
      
      - name: Deploy to Staging
        env:
          DB_PASSWORD: ${{ secrets.STAGING_DB_PASSWORD }}
          GRAFANA_PASSWORD: ${{ secrets.STAGING_GRAFANA_PASSWORD }}
        run: |
          echo "ğŸš€ Desplegando a Staging..."
          export DB_PASSWORD="${DB_PASSWORD}"
          export GRAFANA_PASSWORD="${GRAFANA_PASSWORD}"
          docker-compose -f docker-compose.staging.yml up -d
          echo "â³ Esperando servicios..."
          sleep 20
      
      - name: Initialize staging database
        run: |
          docker-compose -f docker-compose.staging.yml exec -T app \
            python3 -c "from app import create_app, db; app = create_app(); app.app_context().push(); db.create_all()" || true
      
      - name: Verify staging deployment
        run: |
          echo "ğŸ” Verificando health check..."
          for i in {1..10}; do
            if curl -f http://localhost:5001/health; then
              echo "âœ… Staging deployment exitoso!"
              exit 0
            fi
            echo "Intento $i/10..."
            sleep 3
          done
          echo "âŒ Staging deployment fallÃ³"
          docker-compose -f docker-compose.staging.yml logs
          exit 1
      
      - name: Smoke tests
        run: |
          curl -X POST http://localhost:5001/api/tasks \
            -H "Content-Type: application/json" \
            -d '{"title": "Staging Test", "description": "Automated"}' -f
          
          curl -f http://localhost:5001/api/tasks
          echo "âœ… Smoke tests passed!"
      
      - name: Deployment summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ STAGING DEPLOYMENT EXITOSO"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ API: http://localhost:5001"
          echo "ğŸ“Š Prometheus: http://localhost:9091"
          echo "ğŸ“ˆ Grafana: http://localhost:3001"
          echo "âœ… Commit: ${{ github.sha }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: self-hosted
    needs: integration-tests
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: http://localhost:5002
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Stop previous production containers
        run: |
          docker-compose -f docker-compose.prod.yml down || true
      
      - name: Backup database (simulado)
        run: |
          echo "ğŸ“¦ Backup: backup-$(date +%Y%m%d-%H%M%S).sql"
      
      - name: Deploy to Production
        env:
          DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
          GRAFANA_PASSWORD: ${{ secrets.PROD_GRAFANA_PASSWORD }}
        run: |
          echo "ğŸš€ Desplegando a PRODUCTION..."
          export DB_PASSWORD="${DB_PASSWORD}"
          export GRAFANA_PASSWORD="${GRAFANA_PASSWORD}"
          docker-compose -f docker-compose.prod.yml up -d
          echo "â³ Esperando servicios..."
          sleep 25
      
      - name: Initialize production database
        run: |
          docker-compose -f docker-compose.prod.yml exec -T app \
            python3 -c "from app import create_app, db; app = create_app(); app.app_context().push(); db.create_all()" || true
      
      - name: Verify production deployment
        run: |
          echo "ğŸ” Verificando production..."
          for i in {1..15}; do
            if curl -f http://localhost:5002/health; then
              echo "âœ… Production deployment exitoso!"
              exit 0
            fi
            echo "Intento $i/15..."
            sleep 5
          done
          echo "âŒ Deployment fallÃ³ - rollback"
          docker-compose -f docker-compose.prod.yml logs
          docker-compose -f docker-compose.prod.yml down
          exit 1
      
      - name: Production smoke tests
        run: |
          curl -f http://localhost:5002/health
          curl -f http://localhost:5002/ready
          curl -f http://localhost:5002/api/tasks
          echo "âœ… Production tests passed!"
      
      - name: Production summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ PRODUCTION DEPLOYMENT COMPLETADO"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Application: http://localhost:5002"
          echo "ğŸ“Š Prometheus: http://localhost:9092"
          echo "ğŸ“ˆ Grafana: http://localhost:3002"
          echo "âœ… Commit: ${{ github.sha }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "âŒ Rollback automÃ¡tico"
          docker-compose -f docker-compose.prod.yml down
